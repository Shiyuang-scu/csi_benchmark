{% extends "base.html" %}

{% block app_content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<h1>User: {{ user.username }}</h1>
{% if user.who_we_are %}<p>Who we are : {{ user.who_we_are }}</p>{% endif %}
{% if user.what_we_do %}<p>What we do : {{ user.what_we_do }}</p>{% endif %}
{% if user.best_submitted_file %}<p>Best submitted file : {{ best_submitted_file }}</p>{% endif %}
{% if user == current_user %}
<p><a href="{{ url_for('edit_profile') }}">Edit your profile</a></p>
{% endif %}

<h1>Our submissions</h1>
<table class="table table-striped table-hover .table-responsive">
    <thead>
        <tr>
            <th>Filename</th>
            <th>Timestamp</th>
            <th>View obja</th>
            {% if user == current_user %}
            <th>Delete Submission</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for model in sub_files %}
            <tr>
                <td> {{ model.filename }}</td>
                <td> {{ model.timestamp }} </td>
                <td><a href="{{ url_for('stream', model=model.filename )}}" target="_blank">Stream</a> </td>
                {% if user == current_user %}
                <td><a href="{{ url_for('del_sub', sub_file_id=model.id)}}">Delete Submission</a></td>
                {% endif %}
            </tr>
            
        {% endfor %}
    </tbody>

</table>
<hr>
<canvas id="best_submit_canvas" width="400" height="200"></canvas>
<canvas id="quality_comparison" width="400" height="200"></canvas>
<canvas id="middleburry_acc_canvas" width="400" height="200"></canvas>
<canvas id="middleburry_comp_canvas" width="400" height="200"></canvas>
<canvas id="compression_comparison" width="600" height="400"></canvas>
<script>
    {% if user.best_submitted_file %}
    var colours = ['#332288', '#88CCEE', '#44AA99', '#117733', '#999933', '#DDCC77', '#CC6677', '#882255', '#AA4499'];
    var index = 0;
    new Chart.Scatter(document.getElementById("best_submit_canvas"), {
        type: 'line',
        data: {
            datasets: [
                {% for s in sub_files %}
                {%if s.id == user.best_submitted_file %}
                    {
                        data: [
                            {% for abs,ord in zip(format_tabs(s.tab_absc),format_tabs(s.tab_hausdorff)) %}
                                {y: {{ord}}, x:{{abs}}},
                            {% endfor %}
                        ],
                        label: "{{s.filename}} - Hausdorff distance",
                        borderColor: colours[index++],
                        showline: true,
                    },
                    {
                        data: [
                            {% for abs,ord in zip(format_tabs(s.tab_absc),format_tabs(s.tab_middle_accurracy)) %}
                                {y: {{ord}}, x:{{abs}}},
                            {% endfor %}
                        ],
                        label: "{{s.filename}} - Middleburry Accurracy",
                        borderColor: colours[index++],
                        showline: true,
                    },
                    {
                        data: [
                            {% for abs,ord in zip(format_tabs(s.tab_absc),format_tabs(s.tab_middle_completeness)) %}
                                {y: {{ord}}, x:{{abs}}},
                            {% endfor %}
                        ],
                        label: "{{s.filename}} - Middleburry Completeness",
                        borderColor: colours[index++],
                        showline: true,
                    },
                {% endif %}
                {% endfor %}
            ]
        },
        options: {
            title: {
                display: true,
                text: 'Best Submitted File'
            },
            scales:{
                xAxes:[{scaleLabel:{display: true,labelString:'Pourcentage de bits transmis'}}],
                yAxes:[{scaleLabel:{display: true,labelString:'Qualité du maillage'}}]
            },
            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        const dataset = data.datasets[tooltipItem.datasetIndex];
                        const index = tooltipItem.index;
                        return dataset.labels[index] + ' : ' + dataset.data[index];
                    }
                }
            }
        }
    });
    {%endif%}
    var colours = ['#332288', '#88CCEE', '#44AA99', '#117733', '#999933', '#DDCC77', '#CC6677', '#882255', '#AA4499'];
    var index = 0;
    new Chart.Scatter(document.getElementById("quality_comparison"), {
        type: 'line',
        data: {
            datasets: [
                {% for s in sub_files %}
                    {
                        data: [
                            {% for abs,ord in zip(format_tabs(s.tab_absc),format_tabs(s.tab_hausdorff)) %}
                                {y: {{ord}}, x:{{abs}}},
                            {% endfor %}
                        ],
                        label: "{{s.filename}}",
                        borderColor: colours[index++],
                        showline: true,
                    },
                {% endfor %}
            ]
        },
        options: {
            title: {
                display: true,
                text: 'Quality Comparison between submitted files'
            },
            scales:{
                xAxes:[{scaleLabel:{display: true,labelString:'Pourcentage de bits transmis'}}],
                yAxes:[{scaleLabel:{display: true,labelString:'Qualité du maillage'}}]
            },
            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        const dataset = data.datasets[tooltipItem.datasetIndex];
                        const index = tooltipItem.index;
                        return dataset.labels[index] + ' : ' + dataset.data[index];
                    }
                }
            }
        }
    });
    var colours = ['#332288', '#88CCEE', '#44AA99', '#117733', '#999933', '#DDCC77', '#CC6677', '#882255', '#AA4499'];
    var index = 0;
    new Chart.Scatter(document.getElementById("middleburry_acc_canvas"), {
        type: 'line',
        data: {
            datasets: [
                {% for s in sub_files %}
                    {
                        data: [
                            {% for abs,ord in zip(format_tabs(s.tab_absc),format_tabs(s.tab_middle_accurracy)) %}
                                {y: {{ord}}, x:{{abs}}},
                            {% endfor %}
                        ],
                        label: "{{s.filename}}",
                        borderColor: colours[index++],
                        showline: true,
                    },
                {% endfor %}
            ]
        },
        options: {
            title: {
                display: true,
                text: 'Quality Comparison between submitted files'
            },
            scales:{
                xAxes:[{scaleLabel:{display: true,labelString:'Pourcentage de bits transmis'}}],
                yAxes:[{scaleLabel:{display: true,labelString:'Précision du modèle'}}]
            },
            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        const dataset = data.datasets[tooltipItem.datasetIndex];
                        const index = tooltipItem.index;
                        return dataset.labels[index] + ' : ' + dataset.data[index];
                    }
                }
            }
        }
    });
    var colours = ['#332288', '#88CCEE', '#44AA99', '#117733', '#999933', '#DDCC77', '#CC6677', '#882255', '#AA4499'];
    var index = 0;
    new Chart.Scatter(document.getElementById("middleburry_comp_canvas"), {
        type: 'line',
        data: {
            datasets: [
                {% for s in sub_files %}
                    {
                        data: [
                            {% for abs,ord in zip(format_tabs(s.tab_absc),format_tabs(s.tab_middle_completeness)) %}
                                {y: {{ord}}, x:{{abs}}},
                            {% endfor %}
                        ],
                        label: "{{s.filename}}",
                        borderColor: colours[index++],
                        showline: true,
                    },
                {% endfor %}
            ]
        },
        options: {
            title: {
                display: true,
                text: 'Quality Comparison between submitted files'
            },
            scales:{
                xAxes:[{scaleLabel:{display: true,labelString:'Pourcentage de bits transmis'}}],
                yAxes:[{scaleLabel:{display: true,labelString:'Complétude du maillage'}}]
            },
            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        const dataset = data.datasets[tooltipItem.datasetIndex];
                        const index = tooltipItem.index;
                        return dataset.labels[index] + ' : ' + dataset.data[index];
                    }
                }
            }
        }
    });

    var barChartData = {
            labels: [
                {% for s in sub_files %}
                    "{{s.filename}}",
                {% endfor %}
                ],
			datasets: [{
				label: 'Real Size',
				backgroundColor: '#ff0000',
				borderColor: '##ff0000',
				borderWidth: 1,
				data: [
                    {% for s in sub_files %}
                        {{s.real_size}},
                    {% endfor %}
				]
			}, {
				label: 'Estimated size',
				backgroundColor: "#00ff00",
				borderColor: "#00ff00",
				borderWidth: 1,
				data: [
                    {% for s in sub_files %}
                        {{s.estimated_size}},
                    {% endfor %}
				]
			}]
        };

    new Chart(document.getElementById("compression_comparison"), {
        type: 'bar',
        data: barChartData,
        options: {
					responsive: true,
					legend: {
						position: 'top',
					},
					title: {
						display: true,
						text: 'Comparaison des tailles de fichier en octets'
                    },
                    scales:{
                        xAxes:[{scaleLabel:{display: true,labelString:'Modèle 3D'}}],
                        yAxes:[{scaleLabel:{display: true,labelString:'Taille (en octets) du modèle 3D'}}]
                    }
				}
    });
</script>
{% endblock %}